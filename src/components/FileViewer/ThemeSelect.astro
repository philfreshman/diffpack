<div class="flex items-center gap-2">
	<label
		for="prism-theme"
		class="text-xs text-neutral-500 dark:text-neutral-400"
	>
		Theme:
	</label>
	<select
		id="prism-theme"
		class="text-xs bg-transparent border-none focus:ring-0 text-neutral-700 dark:text-neutral-300 cursor-pointer"
	>
		<optgroup label="Standard Themes">
			<option value="prism">Default</option>
			<option value="prism-dark">Dark</option>
			<option value="prism-okaidia">Okaidia</option>
			<option value="prism-solarizedlight">Solarized Light</option>
			<option value="prism-tomorrow">Tomorrow Night</option>
			<option value="prism-twilight">Twilight</option>
		</optgroup>
		<optgroup label="Prism Themes Repo">
			<option value="atom-dark">Atom Dark</option>
			<option value="cb">CB</option>
			<option value="dracula">Dracula</option>
			<option value="duotone-dark">Duotone Dark</option>
			<option value="duotone-earth">Duotone Earth</option>
			<option value="duotone-forest">Duotone Forest</option>
			<option value="duotone-light">Duotone Light</option>
			<option value="duotone-sea">Duotone Sea</option>
			<option value="duotone-space">Duotone Space</option>
			<option value="ghcolors">GitHub Colors</option>
			<option value="material-dark">Material Dark</option>
			<option value="material-light">Material Light</option>
			<option value="material-oceanic">Material Oceanic</option>
			<option value="night-owl">Night Owl</option>
			<option value="nord">Nord</option>
			<option value="shades-of-purple">Shades of Purple</option>
			<option value="synthwave84">Synthwave 84</option>
			<option value="vs">VS</option>
			<option value="vsc-dark-plus">VSC Dark Plus</option>
			<option value="xonokai">Xonokai</option>
		</optgroup>
	</select>
</div>

<script>
	function initThemeSelect() {
		const themeSelect = document.getElementById(
			"prism-theme",
		) as HTMLSelectElement;

		let themeStyle = document.getElementById(
			"prism-theme-style",
		) as HTMLStyleElement;

		if (!themeStyle) {
			themeStyle = document.createElement("style");
			themeStyle.id = "prism-theme-style";
			document.head.appendChild(themeStyle);
		}

		const THEME_STORAGE_KEY = "prism_theme";

		// Load saved theme
		const savedTheme = localStorage.getItem(THEME_STORAGE_KEY) || "prism";
		if (themeSelect) themeSelect.value = savedTheme;
		updatePrismTheme(savedTheme, themeStyle);

		themeSelect?.addEventListener("change", (e) => {
			const theme = (e.target as HTMLSelectElement).value;
			localStorage.setItem(THEME_STORAGE_KEY, theme);
			updatePrismTheme(theme, themeStyle);
		});
	}

	async function updatePrismTheme(theme: string, themeStyle: HTMLStyleElement) {
		const isStandardTheme = [
			"prism",
			"prism-dark",
			"prism-okaidia",
			"prism-solarizedlight",
			"prism-tomorrow",
			"prism-twilight",
		].includes(theme);

		const themes = import.meta.glob(
			[
				"/node_modules/prismjs/themes/*.css",
				"/node_modules/prism-themes/themes/*.css",
			],
			{ query: "?raw", eager: true },
		);

		const themeKey = isStandardTheme
			? `/node_modules/prismjs/themes/${theme}.css`
			: `/node_modules/prism-themes/themes/prism-${theme}.css`;

		const cssModule = themes[themeKey] as { default: string } | undefined;
		if (cssModule) {
			themeStyle.textContent = cssModule.default;
		} else {
			console.error(`Theme not found: ${themeKey}`);
			const defaultTheme = themes["/node_modules/prismjs/themes/prism.css"] as
				| { default: string }
				| undefined;
			if (defaultTheme) {
				themeStyle.textContent = defaultTheme.default;
			}
		}
	}

	initThemeSelect();
	document.addEventListener("astro:page-load", initThemeSelect);
</script>
