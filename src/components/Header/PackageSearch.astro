---
import ResetIcon from "../Icons/ResetIcon.astro";
import SearchIcon from "../Icons/SearchIcon.astro";

const { registry } = Astro.props;
---

<div class="flex-2 relative" data-registry={registry}>
	<label
		for="package-search"
		class="absolute -top-5 text-xs font-medium text-neutral-700 dark:text-neutral-300 mb-1"
	>
		Package Name
	</label>
	<div class="relative">
		<input
			id="package-search"
			type="text"
			value=""
			placeholder={`Search ${registry || 'package'}s...`}
			autocomplete="off"
			class="w-full px-4 py-2 pr-10 bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm text-neutral-900 dark:text-white placeholder-neutral-400 dark:placeholder-neutral-500"
		>
		<div
			id="search-loading"
			class="absolute right-3 top-1/2 -translate-y-1/2 hidden"
		>
			<div
				class="animate-spin rounded-full h-4 w-4 border-2 border-blue-500 border-t-transparent"
			></div>
		</div>
		<div id="search-icon" class="absolute right-3 top-1/2 -translate-y-1/2">
			<SearchIcon class="w-4 h-4 text-neutral-400 dark:text-neutral-500" />
		</div>
		<button
			id="search-reset"
			type="button"
			class="absolute right-3 top-1/2 -translate-y-1/2 hidden"
			aria-label="Reset search"
		>
			<ResetIcon
				class="w-4 h-4 text-neutral-400 hover:text-neutral-600 dark:text-neutral-500 dark:hover:text-neutral-300"
			/>
		</button>

		<!-- Search Results Dropdown -->
		<div
			id="search-results"
			class="absolute z-50 w-full mt-1 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-700 rounded-lg shadow-lg overflow-hidden hidden"
		>
			<div id="search-results-list" class="max-h-80 overflow-y-auto"></div>
		</div>
	</div>
</div>

<script>
	import { searchPackages } from "../../registries/searchService.ts";
	import type { SearchResult } from "../../registries/types.ts";
	import { escapeHTML } from "../../utils/dom.ts";

	let abortController: AbortController | null = null;

	function initPackageSearch() {
		if (abortController) abortController.abort();
		abortController = new AbortController();
		const { signal } = abortController;

		const input = document.getElementById("package-search") as HTMLInputElement;
		const resultsDropdown = document.getElementById("search-results");
		const resultsList = document.getElementById("search-results-list");
		const loadingIcon = document.getElementById("search-loading");
		const searchIcon = document.getElementById("search-icon");
		const resetButton = document.getElementById("search-reset");
		const registry =
			(document.querySelector("[data-registry]") as HTMLElement)?.dataset
				.registry || "npm";

		if (!input) return;

		let searchTimeout: ReturnType<typeof setTimeout>;
		let currentResults: SearchResult[] = [];
		let selectedIndex = -1;
		let selectedPackage: string | null = null;
		let isLoading = false;

		const HISTORY_KEY = `search_history_${registry}`;

		function getHistory(): SearchResult[] {
			try {
				const history = localStorage.getItem(HISTORY_KEY);
				return history ? JSON.parse(history) : [];
			} catch {
				return [];
			}
		}

		function saveToHistory(pkg: SearchResult) {
			const history = getHistory();
			const newHistory = [
				pkg,
				...history.filter((item) => item.name !== pkg.name),
			].slice(0, 10);
			localStorage.setItem(HISTORY_KEY, JSON.stringify(newHistory));
		}

		function updateActionIcon() {
			if (isLoading) {
				loadingIcon?.classList.remove("hidden");
				searchIcon?.classList.add("hidden");
				resetButton?.classList.add("hidden");
				return;
			}

			loadingIcon?.classList.add("hidden");
			const showReset = Boolean(selectedPackage);
			resetButton?.classList.toggle("hidden", !showReset);
			searchIcon?.classList.toggle("hidden", showReset);
		}

		function showLoading(show: boolean) {
			isLoading = show;
			updateActionIcon();
		}

		function renderResults(results: SearchResult[]) {
			if (!resultsDropdown || !resultsList) return;
			if (results.length === 0) {
				hideResults();
				return;
			}

			resultsList.innerHTML = results
				.map((r, i) => {
					const name = escapeHTML(r.name);
					const description = r.description ? escapeHTML(r.description) : "";
					return `
            <div class="search-item px-4 py-2.5 cursor-pointer hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors" data-index="${i}" data-name="${name}">
                <div class="font-medium text-sm text-neutral-900 dark:text-white">${name}</div>
                ${description ? `<p class="text-xs text-neutral-600 dark:text-neutral-400 mt-0.5 truncate">${description}</p>` : ""}
            </div>
        `;
				})
				.join("");

			resultsDropdown.classList.remove("hidden");
			selectedIndex = -1;
			resultsList.scrollTop = 0;
		}

		function hideResults() {
			resultsDropdown?.classList.add("hidden");
		}

		function selectPackage(name: string) {
			input.value = name;
			selectedPackage = name;
			updateActionIcon();
			hideResults();

			const pkg = currentResults.find((r) => r.name === name);
			if (pkg) {
				saveToHistory(pkg);
			}

			window.dispatchEvent(
				new CustomEvent("package-selected", { detail: { name, pkg } }),
			);
		}

		function resetSearch() {
			selectedPackage = null;
			currentResults = [];
			input.value = "";
			hideResults();
			updateActionIcon();
			window.dispatchEvent(new CustomEvent("package-reset"));
			input.focus();
			const history = getHistory();
			if (history.length > 0) {
				currentResults = history;
				renderResults(history, true);
			}
		}

		// Search input handler
		input.addEventListener(
			"input",
			(e) => {
				const query = (e.target as HTMLInputElement).value;
				clearTimeout(searchTimeout);
				if (selectedPackage && query !== selectedPackage) {
					selectedPackage = null;
					updateActionIcon();
				}
				if (query.length === 0) {
					const history = getHistory();
					if (history.length > 0) {
						currentResults = history;
						renderResults(history, true);
					} else {
						hideResults();
					}
					return;
				}
				if (query.length < 2) {
					hideResults();
					return;
				}

				searchTimeout = setTimeout(async () => {
					showLoading(true);
					try {
						currentResults = await searchPackages(query);
						renderResults(currentResults);
					} catch (e) {
						console.error(e);
					} finally {
						showLoading(false);
					}
				}, 300);
			},
			{ signal },
		);

		input.addEventListener(
			"focus",
			() => {
				if (input.value.length === 0) {
					const history = getHistory();
					if (history.length > 0) {
						currentResults = history;
						renderResults(history, true);
					}
				} else if (currentResults.length > 0) {
					renderResults(currentResults);
				}
			},
			{ signal },
		);

		input.addEventListener(
			"blur",
			() => {
				// Small delay to allow click events on dropdown items to fire first
				setTimeout(() => {
					hideResults();
				}, 100);
			},
			{ signal },
		);

		resetButton?.addEventListener("click", resetSearch, { signal });

		// Click handler
		resultsList?.addEventListener(
			"click",
			(e) => {
				const item = (e.target as HTMLElement).closest(
					".search-item",
				) as HTMLElement;
				if (item) {
					const name = item.dataset.name;
					if (name) selectPackage(name);
				}
			},
			{ signal },
		);

		// Keyboard navigation
		input.addEventListener(
			"keydown",
			(e) => {
				const isHidden = resultsDropdown?.classList.contains("hidden");
				if (e.key === "Enter" && isHidden) {
					if (input.value.trim()) {
						selectPackage(input.value.trim());
					}
					return;
				}

				if (isHidden && e.key === "ArrowDown" && input.value.length === 0) {
					const history = getHistory();
					if (history.length > 0) {
						currentResults = history;
						renderResults(history, true);
						return;
					}
				}

				if (isHidden) return;

				const items = resultsList?.querySelectorAll(".search-item");
				if (!items?.length) return;

				if (e.key === "ArrowDown") {
					e.preventDefault();
					selectedIndex = (selectedIndex + 1) % items.length;
					updateHighlight(items);
				} else if (e.key === "ArrowUp") {
					e.preventDefault();
					selectedIndex = (selectedIndex - 1 + items.length) % items.length;
					updateHighlight(items);
				} else if (e.key === "Enter") {
					e.preventDefault();
					if (selectedIndex >= 0) {
						const name = (items[selectedIndex] as HTMLElement).dataset.name;
						if (name) selectPackage(name);
					} else if (input.value.trim()) {
						selectPackage(input.value.trim());
					}
				} else if (e.key === "Escape") {
					hideResults();
				}
			},
			{ signal },
		);

		function updateHighlight(items: NodeListOf<Element>) {
			items.forEach((item, i) => {
				item.classList.toggle("bg-blue-50", i === selectedIndex);
				item.classList.toggle("dark:bg-neutral-800", i === selectedIndex);
			});
		}

		window.addEventListener(
			"package-selected",
			(e: Event) => {
				const detail = (e as CustomEvent).detail;
				if (detail?.name) {
					selectedPackage = detail.name;
					if (detail.pkg) {
						saveToHistory(detail.pkg);
					}
					updateActionIcon();
				}
			},
			{ signal },
		);

		if (input.value) {
			selectedPackage = input.value;
			updateActionIcon();
		} else {
			updateActionIcon();
		}
	}

	initPackageSearch();
	document.addEventListener("astro:page-load", initPackageSearch);
</script>
